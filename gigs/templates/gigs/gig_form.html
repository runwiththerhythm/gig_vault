{% extends "gigs/dashboard_base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block head_extra %}
  {{ form.media }}
{% endblock %}

{% block page_header %}
  <h2>{{ view.object.pk|yesno:"Edit Gig,Add New Gig" }}</h2>
{% endblock %}

{% block dashboard_content %}
<div class="container mt-4">
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form|crispy }}

  <!-- Mapbox Search element (needs mapbox_token from context) -->
  <mapbox-search-box
    id="venue-search-box"
    access-token="{{ mapbox_token }}"
    placeholder="Search for a venueâ€¦"
    style="width:100%; max-width:400px;"
    countries="gb"
    types="poi">
  </mapbox-search-box>

  {% if form.instance.venue %}
    <p class="mt-2">
      <strong>Selected venue:</strong>
      {{ form.instance.venue.name }}, {{ form.instance.venue.city }}{% if form.instance.venue.country %}, {{ form.instance.venue.country }}{% endif %}
    </p>
  {% endif %}

  <!-- Hidden venue fields the view expects -->
  <input type="hidden" id="id_venue_name" name="venue_name" value="{{ form.instance.venue.name|default:'' }}">
  <input type="hidden" id="venue_city" name="venue_city" value="{{ form.instance.venue.city|default:'' }}">
  <input type="hidden" id="venue_country" name="venue_country" value="{{ form.instance.venue.country|default:'' }}">


{# --- Images - New uploads (multi) --- #}
  <div class="mt-4">
  <h4 class="mb-2">Add Photos</h4>

<!-- Plain file input: not a Django form field -->
  <input id="id_images" name="images" type="file" multiple class="d-none" accept="image/*">
  
  <!-- Dropzone + button -->
  <div id="image-dropzone" class="border rounded p-4 text-center bg-light">
    <p class="mb-2">Drag & drop images here, or</p>
    <button type="button" id="btn-pick-images" class="btn btn-outline-primary">
      Select imagesâ€¦
    </button>
    <div class="form-text mt-2" id="selected-images" aria-live="polite"></div>
  </div>

  <!-- Live preview grid -->
  <div id="image-previews" class="row row-cols-2 row-cols-sm-3 row-cols-md-4 g-3 mt-2"></div>

  <small class="text-muted d-block mt-2">
    JPG/PNG/WebP, up to ~10MB each. You can add more files in multiple picks/drops before saving.
  </small>
  </div>

    {# Image Formset Section #}
  <h4 class="mt-4">Images</h4>


  {{ formset.non_form_errors }}                {# show formset-level errors #}
  {{ formset.management_form }}

  {% for f in formset %}
    <div class="mb-3 border p-2 rounded">

    {# hidden fields like id #}
    {% for hidden in f.hidden_fields %}
      {{ hidden }}
    {% endfor %}

    {# per-form non-field errors #}
    {{ f.non_field_errors }}

    <div class="mb-2">
      {{ f.image.label_tag }} {{ f.image }}
      {% if f.image.errors %}
        <div class="text-danger small">{{ f.image.errors }}</div>
      {% endif %}
    </div>

    <div class="form-check mb-2">
      {{ f.is_cover }} {{ f.is_cover.label_tag }}
      {% if f.is_cover.errors %}
        <div class="text-danger small">{{ f.is_cover.errors }}</div>
      {% endif %}
    </div>

    {% if f.instance.pk %}
      <div class="mt-2 d-flex align-items-center gap-3">
        <img src="{{ f.instance.image.url }}" alt="" style="max-height:100px;">
        <label class="form-check-label">
          {{ f.DELETE }} Delete this image
        </label>
      </div>
    {% endif %}
    </div>
  {% empty %}
    <p>No image forms found.</p>
  {% endfor %}

    <button type="submit" class="btn btn-primary mt-3">Save</button>
    <a href="{% url 'my_gigs' %}" class="btn btn-secondary mt-3">Cancel</a>
</form>
</div>

<!-- Add Band Modal -->
<div class="modal fade" id="addBandModal" tabindex="-1" aria-labelledby="addBandModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="add-band-form" method="post" action="{% url 'band_create' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addBandModalLabel">Add New Band</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="id_name" class="form-label">Band Name</label>
            <input type="text" class="form-control" id="id_name" name="name" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Band</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}


{% block scripts %}
  {{ block.super }}

  <!-- Image preview js -->
  <script src="{% static 'js/image-previews.js' %}"></script>

  <!-- Band Modal AJAX-->
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const bandForm = document.getElementById('add-band-form');
    const bandNameInput = document.getElementById('id_name');
    const bandField = document.querySelector('#id_band');  // DAL autocomplete field

    bandForm.addEventListener('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(bandForm);

      fetch("{% url 'band_create' %}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData,
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw data;
          });
        }
        return response.json();
      })
      .then(data => {
        // Success: Add new option to band autocomplete and select it
        const newOption = new Option(data.name, data.id, true, true); // selected by default
        $(bandField).append(newOption).trigger('change');

        // Pass the band ID to the gig creation page (redirect)
      window.location.href = "{% url 'gig_create' %}?band_id=" + data.id;

        // Clear modal input and close modal
        bandNameInput.value = '';
        const modal = bootstrap.Modal.getInstance(document.getElementById('addBandModal'));
        modal.hide();
      })
      .catch(error => {
        if (error.errors && error.errors.name) {
          alert("Error: " + error.errors.name.join(", "));
        } else {
          alert("Error adding band: " + JSON.stringify(error));
        }
      });
    });
  });
  </script>

<!-- Mapbox Search result handler -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchBox = document.querySelector("mapbox-search-box");
    if (!searchBox) return;

    console.log("âœ… Mapbox Search Box initialized");

    searchBox.addEventListener("retrieve", (e) => {
      // Mapbox Search Web Component returns a FeatureCollection
      const fc = e.detail;
      const feat = fc?.features?.[0];
      if (!feat) {
        console.warn("No feature in retrieve event:", fc);
        return;
      }

      // Prefer properties.* (Search JS) and fall back to text/context if present
      const props = feat.properties || {};
      const name =
        props.name ?? feat.text ?? ""; // headline/venue name

      // Context is an object on Search JS (web component), not an array
      const ctx = props.context || {};
      const city =
        ctx.place?.name ?? ctx.locality?.name ?? ""; // city-level name
      const country =
        ctx.country?.name ?? ""; // country name

      document.getElementById("id_venue_name").value = name;
      document.getElementById("venue_city").value = city;
      document.getElementById("venue_country").value = country;

      console.log("ðŸ“Œ Venue fields set:", { name, city, country });
    });
  });
</script>




{% endblock %}

  
