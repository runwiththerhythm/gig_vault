{% extends "gigs/dashboard_base.html" %}
{% load crispy_forms_tags %}

{% block head_extra %}
  {{ form.media }}
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>{{ view.object.pk|yesno:"Edit Gig,Add New Gig" }}</h2>
  <form method="post">
    {% csrf_token %}
<form method="post">
  {% csrf_token %}

  {{ form.non_field_errors }}

  {# ——— Band Field + Button ——— #}
  <div class="mb-3">
    {{ form.band|as_crispy_field }}
    <button type="button" class="btn btn-link p-0 mt-1" data-bs-toggle="modal" data-bs-target="#addBandModal">
      Can’t find the band? Add a new one
    </button>
    {% if form.band.errors %}
      <div class="text-danger">{{ form.band.errors }}</div>
    {% endif %}
  </div>

  {# ——— Now render the rest of the fields with crispy #}
  {{ form.tour_title|as_crispy_field }}
  {{ form.other_artists|as_crispy_field }}
  {{ form.venue|as_crispy_field }}
  {# You can add a similar “Add Venue” button here if desired #}
  {{ form.date|as_crispy_field }}
  {{ form.is_festival|as_crispy_field }}
  {{ form.status|as_crispy_field }}
  {{ form.notes|as_crispy_field }}

  <button type="submit" class="btn btn-primary mt-3">Save</button>
  <a href="{% url 'gig_list' %}" class="btn btn-secondary mt-3">Cancel</a>
</form>

<!-- Add Band Modal -->
<div class="modal fade" id="addBandModal" tabindex="-1" aria-labelledby="addBandModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="add-band-form" method="post" action="{% url 'band_create' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addBandModalLabel">Add New Band</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="id_name" class="form-label">Band Name</label>
            <input type="text" class="form-control" id="id_name" name="name" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Band</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const bandForm = document.getElementById('add-band-form');
  const bandNameInput = document.getElementById('id_name');
  const bandField = document.querySelector('#id_band');  // DAL autocomplete field

  bandForm.addEventListener('submit', function (e) {
    e.preventDefault();

    const formData = new FormData(bandForm);

    fetch("{% url 'band_create' %}", {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
      },
      body: formData,
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw data;
        });
      }
      return response.json();
    })
    .then(data => {
      // Success: Add new option to band autocomplete and select it
      const newOption = new Option(data.name, data.id, true, true); // selected by default
      $(bandField).append(newOption).trigger('change');

      // Clear modal input and close modal
      bandNameInput.value = '';
      const modal = bootstrap.Modal.getInstance(document.getElementById('addBandModal'));
      modal.hide();
    })
    .catch(error => {
      if (error.errors && error.errors.name) {
        alert("Error: " + error.errors.name.join(", "));
      } else {
        alert("Error adding band: " + JSON.stringify(error));
      }
    });
  });
});
</script>

{% endblock %}
