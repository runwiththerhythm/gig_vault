{% extends "gigs/dashboard_base.html" %}
{% load crispy_forms_tags crispy_forms_filters %}
{% load static %}

{% block head_extra %}
  {{ form.media }}
{% endblock %}

{% block page_header %}
  <h2>{{ view.object.pk|yesno:"Edit Gig,Add New Gig" }}</h2>
{% endblock %}

{% block dashboard_content %}

<div class="container mt-4">

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {% crispy form %}

<button type="button"
        id="btn-add-support-artist"
        class="btn btn-outline-secondary btn-sm d-none"
        data-bs-toggle="modal"
        data-bs-target="#addBandModal"
        data-add-band-target="#supports-field">
  + Add support artist
</button>

  <!-- Mapbox Search element (needs mapbox_token from context) -->
  <mapbox-search-box
    id="venue-search-box"
    access-token="{{ mapbox_token }}"
    placeholder="Search for a venue…"
    style="width:100%; max-width:400px;"
    countries="gb"
    types="poi">
  </mapbox-search-box>

  {% if form.instance.venue %}
    <p class="mt-2">
      <strong>Selected venue:</strong>
      {{ form.instance.venue.name }}, {{ form.instance.venue.city }}{% if form.instance.venue.country %}, {{ form.instance.venue.country }}{% endif %}
    </p>
  {% endif %}

  <!-- Hidden venue fields the view expects -->
  <input type="hidden" id="id_venue_name" name="venue_name" value="{{ form.instance.venue.name|default:'' }}">
  <input type="hidden" id="venue_city" name="venue_city" value="{{ form.instance.venue.city|default:'' }}">
  <input type="hidden" id="venue_country" name="venue_country" value="{{ form.instance.venue.country|default:'' }}">


{# --- Images - New uploads (multi) --- #}
  <div class="mt-4">
  <h4 class="mb-2">Add Photos</h4>

<!-- Plain file input: not a Django form field -->
  <input id="id_images" name="images" type="file" multiple class="d-none" accept="image/*">

  <!-- Dropzone + button -->
  <div id="image-dropzone" class="border rounded p-4 text-center bg-light">
    <p class="mb-2">Drag & drop images here, or</p>
    <button type="button" id="btn-pick-images" class="btn btn-outline-primary">
      Select images…
    </button>
    <div class="form-text mt-2" id="selected-images" aria-live="polite"></div>
  </div>

  <!-- Live preview grid -->
  <div id="image-previews" class="row row-cols-2 row-cols-sm-3 row-cols-md-4 g-3 mt-2"></div>

  <small class="text-muted d-block mt-2">
    JPG/PNG/WebP, up to ~10MB each. You can add more files in multiple picks/drops before saving.
  </small>
  </div>

    {# Image Formset Section #}
  <h4 class="mt-4">Images</h4>


  {{ formset.non_form_errors }}                {# show formset-level errors #}
  {{ formset.management_form }}

  {% for f in formset %}
    <div class="mb-3 border p-2 rounded">

    {# hidden fields like id #}
    {% for hidden in f.hidden_fields %}
      {{ hidden }}
    {% endfor %}

    {# per-form non-field errors #}
    {{ f.non_field_errors }}

    <div class="mb-2">
      {{ f.image.label_tag }} {{ f.image }}
      {% if f.image.errors %}
        <div class="text-danger small">{{ f.image.errors }}</div>
      {% endif %}
    </div>

    <div class="form-check mb-2">
      {{ f.is_cover }} {{ f.is_cover.label_tag }}
      {% if f.is_cover.errors %}
        <div class="text-danger small">{{ f.is_cover.errors }}</div>
      {% endif %}
    </div>

    {% if f.instance.pk %}
      <div class="mt-2 d-flex align-items-center gap-3">
        <img src="{{ f.instance.image.url }}" alt="" style="max-height:100px;">
        <label class="form-check-label">
          {{ f.DELETE }} Delete this image
        </label>
      </div>
    {% endif %}
    </div>
  {% empty %}
    <p>No image forms found.</p>
  {% endfor %}

    <button type="submit" class="btn btn-primary mt-3">Save</button>
    <a href="{% url 'my_gigs' %}" class="btn btn-secondary mt-3">Cancel</a>
</form>
</div>

<!-- Add Band Modal -->
<div class="modal fade" id="addBandModal" tabindex="-1" aria-labelledby="addBandModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="add-band-form" method="post" action="{% url 'band_create' %}">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title" id="addBandModalLabel">Add New Band</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">

          <!-- Alert Confirm correct band name entry -->
          <div id="band-confirm" class="alert d-none" role="alert"></div>

          <!-- Hints and errors -->
          <div id="band-similar-hint" class="small text-muted mb-2" aria-live="polite"></div>
          <div id="band-error" class="invalid-feedback d-none"></div>

          <div class="mb-3">
            <label for="id_name" class="form-label">Band Name</label>
            <input type="text" class="form-control" id="id_name" name="name" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Band</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Confirm Band Name modal -->
<div class="modal fade" id="confirmBandModal" tabindex="-1" aria-labelledby="confirmBandLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title" id="confirmBandLabel">Confirm band name</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        You’re about to add: <strong id="confirm-band-name"></strong><br>
        Is the spelling correct?
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Back</button>
        <button type="button" class="btn btn-primary btn-sm" id="btn-confirm-create">Yes, create</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast markup (for “Added” + “Undo”) -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080;">
  <div id="band-toast" class="toast align-items-center text-bg-success border-0" role="status" aria-live="polite" aria-atomic="true" data-bs-delay="5000">
    <div class="d-flex">
      <div class="toast-body">
        Band “<span id="band-toast-name"></span>” added.
        <button id="band-toast-undo" type="button" class="btn btn-sm btn-light ms-2">Undo</button>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>

  <!-- optional error toast -->
  <div id="band-toast-error" class="toast align-items-center text-bg-danger border-0 mt-2" role="status" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
    <div class="d-flex">
      <div class="toast-body" id="band-toast-error-text">Something went wrong.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

{% endblock %}


{% block scripts %}
  {{ block.super }}

  <!-- Image preview js -->
  <script src="{% static 'js/image-previews.js' %}"></script>

  <!-- Band Modal AJAX-->
  <script>
document.addEventListener('DOMContentLoaded', function () {
  // --- selects: headliner + supports
  const headlinerField = document.querySelector('#band-field');     // explicit id from GigForm widgets
  const supportsField  = document.querySelector('#supports-field'); // explicit id from GigForm widgets

  // default target = headliner
  let activeSelectEl   = headlinerField;

  // --- modal form + bits
  const bandForm      = document.getElementById('add-band-form');
  if (!bandForm) return;

  const bandInput     = document.getElementById('id_name');
  const addModalEl    = document.getElementById('addBandModal');

  // Confirm modal
  const confirmEl     = document.getElementById('confirmBandModal');
  const confirmNameEl = document.getElementById('confirm-band-name');
  const confirmBtn    = document.getElementById('btn-confirm-create');
  const confirmModal  = confirmEl ? new bootstrap.Modal(confirmEl) : null;

  // Toasts
  const toastEl       = document.getElementById('band-toast');
  const toastNameEl   = document.getElementById('band-toast-name');
  const toastUndoBtn  = document.getElementById('band-toast-undo');
  const errorToastEl  = document.getElementById('band-toast-error');
  const errorTextEl   = document.getElementById('band-toast-error-text');
  const toast         = toastEl ? new bootstrap.Toast(toastEl) : null;
  const errorToast    = errorToastEl ? new bootstrap.Toast(errorToastEl) : null;

  // Hints / errors
  const hintBox       = document.getElementById('band-similar-hint');
  const errorBox      = document.getElementById('band-error');
  const submitBtn     = bandForm.querySelector('button[type="submit"]');

  // CSRF (from form + cookie)
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  }
  const csrftokenCookie = getCookie('csrftoken') || '';

  let lastCreated = null; // {id, name, prevValue, targetId}

  // If you used the “temporary button” trick for supports, move it under the select:
  const addSupportBtn = document.getElementById('btn-add-support-artist');
  if (addSupportBtn && supportsField) {
    supportsField.insertAdjacentElement('afterend', addSupportBtn);
    addSupportBtn.classList.remove('d-none');
  }

  // Which select opened the modal?
  document.querySelectorAll('[data-add-band-target]').forEach(btn => {
    btn.addEventListener('click', () => {
      const sel = btn.getAttribute('data-add-band-target');
      const el  = sel ? document.querySelector(sel) : null;
      activeSelectEl = el || headlinerField;
    });
  });
  addModalEl?.addEventListener('show.bs.modal', () => {
    if (!activeSelectEl) activeSelectEl = headlinerField;
  });

  // Debounce helper
  function debounce(fn, delay=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), delay); }; }

  // Live duplicate lookup
  const fetchSimilar = debounce(async function () {
    const q = (bandInput.value || '').trim();
    if (!q) { hintBox.innerHTML = ''; hintBox.style.display='none'; return; }
    try {
      const url = new URL("{% url 'band_lookup_ajax' %}", window.location.origin);
      url.searchParams.set('q', q);
      const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      const data = await resp.json();
      renderSimilarHint(data);
    } catch {
      hintBox.innerHTML = ''; hintBox.style.display='none';
    }
  }, 300);

  function renderSimilarHint(payload) {
    if (!hintBox) return;
    const exact = payload?.exact;
    const list  = payload?.similar || [];
    let html = '';
    if (exact) {
      html += `
        <div class="mb-1">
          Already exists: <strong>${exact.name}</strong>
          <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="btn-use-existing">Use existing</button>
        </div>`;
    }
    if (list.length) {
      html += `<div class="mt-1">Similar: ${
        list.map(s => `<span class="badge bg-secondary me-1">${s}</span>`).join('')
      }</div>`;
    }
    hintBox.innerHTML = html;
    hintBox.style.display = html ? 'block' : 'none';

    // Use existing -> select in the *active* select, close modal
    if (exact) {
      const btn = document.getElementById('btn-use-existing');
      btn?.addEventListener('click', () => {
        const idStr = String(exact.id);
        if (activeSelectEl) {
          const exists = Array.from(activeSelectEl.options).some(o => o.value === idStr);
          if (!exists) {
            const opt = new Option(exact.name, idStr, true, true);
            if (window.jQuery) jQuery(activeSelectEl).append(opt).trigger('change');
            else { activeSelectEl.appendChild(opt); activeSelectEl.value = idStr; activeSelectEl.dispatchEvent(new Event('change', {bubbles:true})); }
          } else {
            if (window.jQuery) jQuery(activeSelectEl).val(idStr).trigger('change');
            else { activeSelectEl.value = idStr; activeSelectEl.dispatchEvent(new Event('change', {bubbles:true})); }
          }
        }
        bootstrap.Modal.getInstance(addModalEl)?.hide();
      });
    }
  }

  bandInput?.addEventListener('input', () => {
    if (errorBox) { errorBox.textContent=''; errorBox.classList.add('d-none'); }
    bandInput.classList.remove('is-invalid');
    fetchSimilar();
  });

  // Submit -> confirm first (no save yet)
  bandForm.addEventListener('submit', function (e) {
    e.preventDefault();
    const name = (bandInput.value || '').trim();
    if (!name) {
      if (errorBox) { errorBox.textContent='Please enter a band name.'; errorBox.classList.remove('d-none'); }
      bandInput.classList.add('is-invalid');
      return;
    }
    if (confirmModal && confirmNameEl) {
      confirmNameEl.textContent = name;
      confirmModal.show();
    } else {
      doCreate();
    }
  });

  // Confirm -> actually create (AJAX)
  confirmBtn?.addEventListener('click', async function () {
    confirmModal?.hide();
    await doCreate();
  });

  async function doCreate() {
    // Button loading state
    const originalText = submitBtn?.textContent || '';
    submitBtn?.setAttribute('disabled','disabled');
    if (submitBtn) submitBtn.textContent = 'Saving…';

    const formData = new FormData(bandForm);
    const csrfForm = formData.get('csrfmiddlewaretoken') || csrftokenCookie;
    const prevValue = activeSelectEl
      ? (window.jQuery ? jQuery(activeSelectEl).val() : activeSelectEl.value)
      : null;

    try {
      const resp = await fetch(bandForm.action || "{% url 'band_create' %}", {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrfForm || ''
        }
      });
      const data = await resp.json();
      if (!resp.ok || typeof data.id === 'undefined') {
        throw (data?.errors?.name?.join(', ') || 'Could not add band.');
      }

      const idStr = String(data.id);

      // Insert/select in the *active* select
      if (activeSelectEl) {
        const exists = Array.from(activeSelectEl.options).some(o => o.value === idStr);
        if (!exists) {
          const opt = new Option(data.name, idStr, true, true);
          if (window.jQuery) jQuery(activeSelectEl).append(opt).trigger('change');
          else { activeSelectEl.appendChild(opt); activeSelectEl.value = idStr; activeSelectEl.dispatchEvent(new Event('change', {bubbles:true})); }
        } else {
          if (window.jQuery) jQuery(activeSelectEl).val(idStr).trigger('change');
          else { activeSelectEl.value = idStr; activeSelectEl.dispatchEvent(new Event('change', {bubbles:true})); }
        }
      }

      // Close modal, show toast + Undo
      bootstrap.Modal.getInstance(addModalEl)?.hide();
      lastCreated = {
        id: idStr,
        name: data.name,
        prevValue,
        targetId: activeSelectEl?.id || 'band-field'
      };
      if (toast && toastNameEl) {
        toastNameEl.textContent = data.name;
        toast.show();
      }

      // Reset input/hints
      bandInput.value = '';
      hintBox.innerHTML = ''; hintBox.style.display='none';

    } catch (err) {
      if (errorToast && errorTextEl) {
        errorTextEl.textContent = (typeof err === 'string') ? err : 'Could not add band.';
        errorToast.show();
      } else {
        alert((typeof err === 'string') ? err : 'Could not add band.');
      }
    } finally {
      if (submitBtn) submitBtn.textContent = originalText;
      submitBtn?.removeAttribute('disabled');
    }
  }

  // Undo -> server delete (guard) + restore the correct field’s selection
  toastUndoBtn?.addEventListener('click', async function () {
    if (!lastCreated) return;
    try {
      const url = "{% url 'band_delete_ajax' 0 %}".replace('/0/', `/${lastCreated.id}/`);
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrftokenCookie || ''
        }
      });
      const data = await resp.json();
      if (!resp.ok || data.ok !== true) {
        if (data?.reason === 'in_use') throw 'Cannot undo: band is already referenced by a gig.';
        throw 'Undo failed.';
      }

      // choose the right select to update
      const targetEl = (lastCreated?.targetId === 'supports-field') ? supportsField : headlinerField;
      if (targetEl) {
        const opt = Array.from(targetEl.options).find(o => o.value === lastCreated.id);
        if (opt) opt.remove();

        if (window.jQuery) {
          jQuery(targetEl).val(lastCreated.prevValue).trigger('change');
        } else {
          if (Array.isArray(lastCreated.prevValue)) {
            [...targetEl.options].forEach(o => { o.selected = lastCreated.prevValue.includes(o.value); });
          } else {
            targetEl.value = lastCreated.prevValue ?? '';
          }
          targetEl.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }

      new bootstrap.Toast(toastEl).hide();
      lastCreated = null;

    } catch (err) {
      if (errorToast && errorTextEl) {
        errorTextEl.textContent = (typeof err === 'string') ? err : 'Undo failed.';
        errorToast.show();
      } else {
        alert((typeof err === 'string') ? err : 'Undo failed.');
      }
    }
  });
});
</script>

<!-- Mapbox Search result handler -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchBox = document.querySelector("mapbox-search-box");
    if (!searchBox) return;

    console.log("✅ Mapbox Search Box initialized");

    searchBox.addEventListener("retrieve", (e) => {
      // Mapbox Search Web Component returns a FeatureCollection
      const fc = e.detail;
      const feat = fc?.features?.[0];
      if (!feat) {
        console.warn("No feature in retrieve event:", fc);
        return;
      }

      // Prefer properties.* (Search JS) and fall back to text/context if present
      const props = feat.properties || {};
      const name =
        props.name ?? feat.text ?? ""; // headline/venue name

      // Context is an object on Search JS (web component), not an array
      const ctx = props.context || {};
      const city =
        ctx.place?.name ?? ctx.locality?.name ?? ""; // city-level name
      const country =
        ctx.country?.name ?? ""; // country name

      document.getElementById("id_venue_name").value = name;
      document.getElementById("venue_city").value = city;
      document.getElementById("venue_country").value = country;

      console.log("📌 Venue fields set:", { name, city, country });
    });
  });
</script>




{% endblock %}

  
